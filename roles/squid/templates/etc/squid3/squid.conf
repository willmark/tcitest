# {{ ansible_managed }}

#       WELCOME TO SQUID DEB PROXY
#       ------------------
#
#       This config file is a version of a squid proxy file optimized
# as a configuration for a caching proxy for Ubuntu systems.
#
#       More information about squid and its configuration can be found here
#       http://www.squid-cache.org/ and in the FAQ

# settings that you may want to customize
# ---------------------------------------

acl allowed_networks src "/etc/squid3/allowed-networks-src.acl"

acl bbg dstdomain .bbg
{% if squid.proxy_domains|count > 0 -%}
acl allowed_domains dstdomain "/etc/squid3/allowed-domains-dst.acl"
{% endif -%}

# this contains the package blacklist
acl blockedpkgs urlpath_regex "/etc/squid3/pkg-blacklist-regexp.acl"

http_port {{ squid.port }}

# -------------------------------------------------
# settings below probably do not need customization

acl Purge method PURGE
http_access allow localhost Purge
http_access allow allowed_networks Purge
http_access deny Purge

# user visible name
visible_hostname {{ ansible_nodename }}

{% if squid.upstream_proxy|count > 0 -%}
# use upstream proxy cache
{% for proxy in squid.upstream_proxy %}
cache_peer {{ proxy.host }} {{ proxy.type|default("parent") }} {{ proxy.port }} {{ proxy.udp_port|default("0") }} no-query no-digest no-netdb-exchange
{% endfor -%}
always_direct allow bbg
always_direct deny all
never_direct allow allowed_domains
never_direct deny all
{% endif -%}

# we need a big cache, some debs are huge
maximum_object_size 512 MB

cache_dir aufs {{ squid.cache_dir.path }} {{ squid.cache_dir.size }} 16 256

cache_access_log /var/log/squid3/access.log
cache_log /var/log/squid3/cache.log
cache_store_log /var/log/squid3/store.log

cache_effective_user proxy
cache_effective_group proxy

# tweaks to speed things up
cache_mem 200 MB
maximum_object_size_in_memory 10240 KB

# pid
pid_filename /var/run/squid3.pid

# refresh pattern for debs and udebs
refresh_pattern deb$   129600 100% 129600
refresh_pattern udeb$   129600 100% 129600
refresh_pattern tar.gz$  129600 100% 129600

# always refresh Packages and Release files
refresh_pattern \/(Packages|Sources)(|\.bz2|\.gz)$ 0 0% 0
refresh_pattern \/Release(|\.gpg)$ 0 0% 0

# handle meta-release and changelogs.ubuntu.com special
refresh_pattern changelogs.ubuntu.com/*  0  1% 1

# only allow connects to ports for http, https
acl Safe_ports port 80 443 563

# only allow ports we trust
http_access deny !Safe_ports

# do not allow to download from the pkg blacklist
http_access deny blockedpkgs

# allow access from our network and localhost
http_access allow allowed_networks

# allow access to listed domains
http_access allow allowed_domains

# And finally deny all other access to this proxy
http_access deny all

